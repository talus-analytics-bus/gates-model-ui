var App=App||{};!function(){App.inputs=null,App.outputs=null,App.initialize=function(){App.inputs=App.getCookie("inputs"),App.outputs=App.getCookie("outputs"),$(".header-title").click(function(){hasher.setHash("")}),$.noty.defaults.layout="center",$.noty.defaults.type="warning"},App.runModel=function(t,e){NProgress.start();var a=new Date;console.log("starting model run..."),$.get("/runModel",t).always(function(){console.log("finished model run: "+(new Date-a)/1e3+" seconds"),NProgress.done()}).fail(function(){e("error",null)}).done(function(t){t.hasOwnProperty("error")?e(t.error,null):e(null,t)})},App.setCookie=function(t,e,a){if("object"==typeof e&&(e=JSON.stringify(e)),e.length>=4094&&console.log("Cookie is too long! (over 4094 bytes)"),"undefined"==typeof a)var a=7;var n=new Date;n.setTime(n.getTime()+24*a*60*60*1e3);var i="expires="+n.toUTCString();document.cookie=t+"="+e+"; "+i},App.getCookie=function(t){for(var e=t+"=",a=document.cookie.split(";"),n=0;n<a.length;n++){var i=a[n].trim();if(0===i.indexOf(e)){var r=i.substring(e.length,i.length);return JSON.parse(r)}}return null}}();var Routing={};!function(){var t={};Routing.precompileTemplates=function(){$("script[type='text/x-handlebars-template']").each(function(e,a){t[a.id.replace("-template","")]=Handlebars.compile($(a).html())})},Routing.initializeRoutes=function(){crossroads.addRoute("/",function(){a("home"),App.initInput(),window.scrollTo(0,0)}),crossroads.addRoute("/output",function(){a("output"),App.initOutput(),window.scrollTo(0,0)}),hasher.prependHash="",hasher.initialized.add(e),hasher.changed.add(e),hasher.init()};var e=function(t){crossroads.parse(t)},a=function(e,a){$("#page-content").html(t[e](a))}}();var Util={};Util.comma=d3.format(",f"),Util.decimalize=d3.format(".2f"),Util.percentize=d3.format("%"),Util.percentizeDiff=function(t){return 0===t?"0%":d3.format("+%")(t)},Util.strToFloat=function(t){return"string"!=typeof t?t:parseFloat(t.replace(/[^\d\.\-]/g,""))},Util.formatInputVal=function(t){t=$(t);var e=Util.strToFloat(t.val()),a=Util.comma(e);return t.hasClass("percent-input")&&(e/=100,isNaN(e)||0>e?e=0:e>100&&(e=100),a=Util.percentize(e)),t.val(a),e},Util.getUnique=function(t){for(var e=[],a=0;a<t.length;a++)-1===e.indexOf(t[a])&&e.push(t[a]);return e},Util.copyObject=function(t){return $.extend(!0,{},t)};var App=App||{};!function(){App.initInput=function(){var e=$(window).width();null!==App.inputs&&t(),$(".input-section .title").click(function(){var t=$(this).next().find(".input-subsection, .next-button-container"),e=t.is(":visible");e?t.slideUp():($(this).parent().siblings(".input-section").find(".input-subsection, .next-button-container").slideUp(),t.slideDown())}),$(".next-button-container .btn").click(function(){var t=!0;if("pop-age"===$(this).attr("name")&&(t=i()),t){var e=$(this).parent().parent(),a=e.find(".input-subsection, .next-button-container");a.slideUp(),e.parent().next(".input-section").find(".input-subsection, .next-button-container").slideDown()}});var a=[{age:"under 5",value:App.inputs?App.inputs.pop1:.18},{age:"5-15",value:App.inputs?App.inputs.pop2:.3},{age:"16+",value:App.inputs?App.inputs.pop3:.52}];d3.selectAll(".pop-age-table input").property("value",function(t,e){return Util.percentize(a[e].value)}).on("change",function(t,e){a[e].value=Util.formatInputVal(this),n(),m()});var n=function(){for(var t=0,e=0;e<a.length;e++)t+=a[e].value;return $(".pop-age-table tbody tr:last-child td:nth-child(2)").text(Util.percentize(t)),Math.abs(t-1)<.001?($(".pop-age-warning").slideUp(),$(".pop-age-table input").css("background-color","white"),!0):($(".pop-age-warning").slideDown(),$(".pop-age-table input").css("background-color","#ffdbdb"),!1)},i=function(){var t=n();return t||noty({text:"<b>Warning!</b><br>Age distributions must sum to 100%!"}),t},r={top:25,right:20,bottom:48,left:100},s=440>e?e-20:420,o=s-r.left-r.right,p=200-r.top-r.bottom,l=d3.select(".pop-age-chart").attr("width",o+r.left+r.right).attr("height",p+r.top+r.bottom).append("g").attr("transform","translate("+r.left+","+r.top+")");l.append("text").attr("class","axis-label").attr("x",o/2).attr("y",p+45).text("Age");var c=d3.scale.ordinal().domain(a.map(function(t){return t.age})).rangeRoundBands([0,o],.2),u=d3.svg.axis().scale(c).orient("bottom"),h=(l.append("g").attr("class","x axis").attr("transform","translate(0,"+p+")").call(u),d3.scale.linear().domain([0,1]).range([p,0])),d=d3.svg.axis().orient("left").ticks(5).tickFormat(Util.percentize).innerTickSize(-o).outerTickSize(0).scale(h),m=(l.append("g").attr("class","y axis").call(d),function(){var t=l.selectAll("rect").data(a);t.enter().append("rect");t.attr("x",function(t){return c(t.age)}).attr("y",function(t){return h(t.value)}).attr("width",c.rangeBand()).attr("height",function(t){return p-h(t.value)}),t.exit().remove()});m(),$(".schisto-prevalence-container .explanation-icon").tooltipster({maxWidth:350,contentAsHTML:!0,content:"<b>Schistosomiasis prevalence</b> indicates the percentage of the population currently infected with schistosomiasis (medium-high intensity)."}),$(".schisto-prevalence").on("change",function(){var t=Math.round(Util.strToFloat($(this).val()));isNaN(t)?(noty({text:"<b>Error!</b><br>Please select a valid number for schistosomiasis prevalence."}),$(this).val(Util.percentize(.45))):0>=t?(noty({text:"<b>Warning!</b><br>The percentage for schistosomiasis prevalence must be <b>greater than 0%</b>."}),$(this).val(Util.percentize(.01))):t>100?(noty({text:"<b>Warning!</b><br>The maximum percentage for schistosomiasis prevalence is <b>100%</b>."}),$(this).val(Util.percentize(1))):$(this).val(Util.percentize(t/100))}),$(".schisto-age-select").multiselect(),$(".malaria-timing-select").on("change",function(){"seasonal"===$(this).val()?$(".malaria-month-container").slideDown():$(".malaria-month-container").slideUp()}),$(".malaria-month-label").click(function(){var t=$(this).prev();t.prop("checked",!t.is(":checked"))}),$(".irs-checkbox").on("change",function(){g()}),$(".irs-checkbox-label").on("click",function(){$(".irs-checkbox").prop("checked",!$(".irs-checkbox").is(":checked")),g()});var g=function(){$(".irs-true-contents").slideToggle(),f()};$(".itn-checkbox").on("change",function(){b()}),$(".itn-checkbox-label").on("click",function(){$(".itn-checkbox").prop("checked",!$(".itn-checkbox").is(":checked")),b()});var b=function(){$(".itn-true-contents").slideToggle(),f()},f=function(){var t=$(".irs-checkbox").is(":checked")&&$(".itn-checkbox").is(":checked");t?$('.input-subsection[name="distribution-strategy"]').slideDown():$('.input-subsection[name="distribution-strategy"]').slideUp()};$(".input-submit-button").click(function(){var t=[];d3.selectAll(".malaria-month-container input").each(function(e,a){$(this).is(":checked")&&t.push(a+1)}),console.log(t);var e={n_people:2e3,pop1:Util.strToFloat($(".pop-age-table tbody tr:first-child input").val())/100,pop2:Util.strToFloat($(".pop-age-table tbody tr:nth-child(2) input").val())/100,pop3:Util.strToFloat($(".pop-age-table tbody tr:nth-child(3) input").val())/100,schisto_prevalence:Util.strToFloat($(".schisto-prevalence").val())/100,schisto_coverage:Util.strToFloat($(".schisto-coverage-select").val()),schisto_age_range:$(".schisto-age-select").val(),schisto_month_num:$(".schisto-month-select").val(),malaria_timing:$(".malaria-timing-select").val(),malaria_peak_month_num:t,malaria_rate:Util.strToFloat($(".malaria-trans-rate-select").val()),irs:$(".irs-checkbox").is(":checked")?1:0,irs_coverage:Util.strToFloat($(".irs-coverage-select").val()),irs_month_num:$(".irs-month-select").val(),itn:$(".itn-checkbox").is(":checked")?1:0,itn_coverage:Util.strToFloat($(".itn-coverage-select").val()),itn_month_num:$(".itn-month-select").val()};if(i()===!1)return noty({text:"<b>Error!</b><br>Please make sure the age distribution in the population section adds up to 100%!"}),!1;if(null===e.schisto_age_range)return noty({text:"<b>Error!</b><br>Please select an age range for praziquantel mass drug administration under the schistosomiasis section."}),!1;if(!e.irs&&!e.itn)return noty({text:"<b>Error!</b><br>Please select either <b>IRS</b> or <b>ITN</b> as an option for treatment of malaria."}),!1;if("seasonal"===e.malaria_timing&&0===e.malaria_peak_month_num.length)return noty({text:"<b>Error!</b><br>Please select at least 1 peak transmission month for malaria."}),!1;if("seasonal"===e.malaria_timing&&12===e.malaria_peak_month_num.length)return noty({text:"<b>Error!</b><br>For a <b>seasonal</b> malaria transmission pattern, please select less than <b>12</b> peak transmission months"}),!1;App.inputs=e;var a=Util.copyObject(App.inputs);a.use_integration=1;var n=Util.copyObject(App.inputs);n.use_integration=0,queue().defer(App.runModel,a).defer(App.runModel,n).await(function(t,e,a){return t?(console.log("failed to complete all model runs"),console.log(t),noty({type:"alert",text:"<b>Error!</b><br>There was an error running the model. Please contact the developers."}),!1):(App.outputs={integrated:e,separate:a},App.setCookie("inputs",App.inputs),App.setCookie("outputs",App.outputs),void hasher.setHash("output"))})}),$('.input-section[name="pop-age"]').find(".input-subsection, .next-button-container").slideDown()};var t=function(){$(".schisto-coverage-select").val(String(App.inputs.schisto_coverage)),$(".schisto-age-select").val(App.inputs.schisto_age_range),$(".schisto-month-select").val(App.inputs.schisto_month_num),$(".malaria-timing-select").val(App.inputs.malaria_timing),"constant"===App.inputs.malaria_timing&&$(".malaria-month-container").hide(),d3.selectAll(".malaria-month-container input").property("checked",function(t,e){return App.inputs.malaria_peak_month_num.indexOf(e+1)>-1}),$(".malaria-trans-rate-select").val(App.inputs.malaria_rate),$(".irs-checkbox").prop("checked",App.inputs.irs),App.inputs.irs||$(".irs-true-contents").hide(),$(".irs-coverage-select").val(App.inputs.irs_coverage),$(".irs-month-select").val(App.inputs.irs_month_num),$(".itn-checkbox").prop("checked",App.inputs.itn),App.inputs.itn||$(".itn-true-contents").hide(),$(".itn-coverage-select").val(App.inputs.itn_coverage),$(".itn-month-select").val(App.inputs.itn_month_num)}}();var App=App||{};!function(){App.initOutput=function(){if($.isEmptyObject(App.outputs))return hasher.setHash(""),!1;var t=$(window).width(),e="seasonal"===App.inputs.malaria_timing,a=App.outputs.separate.malaria-App.outputs.integrated.malaria>=.05,n=a?App.outputs.integrated:App.outputs.separate;d3.select(".output-recommendation-text").text(a?"INTEGRATED INTERVENTIONS":"NON-INTEGRATED INTERVENTIONS").classed("text-success",a);var i="<b>Non-integrated interventions</b> represents the current strategy using the user-supplied schedule for schistosomiasis and malaria control measures",r="<b>Integrated interventions</b> entails distributing schistosomiasis and malaria control measures together and prior to any seasonal increase in malaria transmission.",s="This is the <b>recommended</b> strategy for the user.";a?r+=" "+s:i+=" "+s,$(".output-recommendation .explanation-icon").tooltipster({maxWidth:450,contentAsHTML:!0,content:i+"<br><br>"+r}),d3.selectAll(".output-table tbody tr").each(function(t,e){var a=0===e?App.outputs.separate:App.outputs.integrated,n=d3.select(this).selectAll("td:nth-child(3), td:nth-child(4)").text(function(t,e){var n=0===e?a.schisto:a.malaria;return Util.percentize(n)});1===e&&n.classed("text-success",function(t,e){var a=0===e?"schisto":"malaria";return Math.round(100*App.outputs.separate[a])-Math.round(100*App.outputs.integrated[a])>=2}).classed("text-danger",function(t,e){var a=0===e?"schisto":"malaria";return Math.round(100*App.outputs.integrated[a])-Math.round(100*App.outputs.separate[a])>=2})});var o=a?2:1;d3.select(".output-table tbody tr:nth-child("+o+") td:first-child").append("img").attr("class","arrow-icon").attr("src","img/chevron_right.png");var p=[{type:"without integration",disease:"schisto",value:App.outputs.separate.schisto},{type:"without integration",disease:"malaria",value:App.outputs.separate.malaria},{type:"with integration",disease:"schisto",value:App.outputs.integrated.schisto},{type:"with integration",disease:"malaria",value:App.outputs.integrated.malaria}],l={top:10,right:20,bottom:80,left:65},c=670>t?t-20:650,u=c-l.left-l.right,h=300-l.top-l.bottom,d=d3.select(".output-bar-chart").attr("width",u+l.left+l.right).attr("height",h+l.top+l.bottom).append("g").attr("transform","translate("+l.left+","+l.top+")"),m=d3.scale.ordinal().domain(Util.getUnique(p.map(function(t){return t.disease}))).rangeRoundBands([0,u],.5),g=d3.svg.axis().scale(m).orient("bottom"),b=(d.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(g),d3.scale.linear().domain([0,1]).range([h,0])),f=d3.svg.axis().orient("left").ticks(5).tickFormat(Util.percentize).innerTickSize(-u).outerTickSize(0).scale(b),v=(d.append("g").attr("class","y axis").call(f),d.selectAll("rect").data(p));v.enter().append("rect").attr("class","bar");v.style("fill",function(t){return"without integration"===t.type?"url(#diagonal-stripe-1)":"steelblue"}).attr("x",function(t){var e=m(t.disease)-20;return"with integration"===t.type&&(e+=40),e}).attr("y",function(t){return b(t.value)}).attr("width",m.rangeBand()).attr("height",function(t){return h-b(t.value)}),v.exit().remove(),d.append("text").attr("class","axis-label").attr("transform","rotate(-90)").attr("x",-h/2).attr("y",-55).text("% Prevalence");var x=450>c?0:(c-450)/2,A=d.append("g").attr("class","legend").attr("transform","translate("+x+","+(h+50)+")"),y=A.selectAll("g").data(Util.getUnique(p.map(function(t){return t.type}))).enter().append("g").attr("transform",function(t,e){return"translate("+200*e+")"});y.append("rect").attr("width",15).attr("height",15).style("fill",function(t){return"without integration"===t?"url(#diagonal-stripe-1)":"steelblue"}),y.append("text").attr("transform","translate(25,13)").text(function(t){return t}),$(".output-table-container .explanation-icon:first-child").tooltipster({maxWidth:400,contentAsHTML:!0,content:"The values shown are prevalence values for schistosomiasis and malaria when <b>non-integrated interventions</b> are used"}),$(".output-table-container .explanation-icon:nth-child(2)").tooltipster({maxWidth:450,contentAsHTML:!0,content:"The values shown are prevalence values for schistosomiasis and malaria when <b>integrated interventions</b> are used. <br><br>Values are colored <b>green</b> if there is a non-trival reduction in prevalence (> 1% reduction). <br><br>Values are colored <b>red</b> if there is a non-trivial increase in prevalence (> 1% increase)."});var _=function(t){return d3.time.format("%B")(new Date(2015,t-1,1,0,0,0,0))};d3.select("#rec_pzq_month").text(_(n.pzq_month)),App.inputs.irs?d3.select("#rec_spray_month").text(_(n.spray_month)):$(".output-strategy-table tbody tr:nth-child(2)").hide(),App.inputs.itn?d3.select("#rec_net_month").text(_(n.net_month)):$(".output-strategy-table tbody tr:nth-child(3)").hide();var k=+App.inputs.schisto_month_num===+n.pzq_month&&+App.inputs.irs_month_num===+n.spray_month&&+App.inputs.itn_month_num===+n.net_month,w={top:20,right:105,bottom:e?105:70,left:105},T=820>t?t-20:800,U=T-l.left-l.right,z=60,I=20,N=k?z:2*z+I,R=d3.select(".output-timeline").attr("width",U+w.left+w.right).attr("height",N+w.top+w.bottom).append("g").attr("transform","translate("+w.left+","+w.top+")"),S=R.append("g").attr("class","timeline-group"),D=R.append("g").attr("class","timeline-group").attr("transform","translate(0,"+(z+I)+")"),E=R.selectAll(".timeline-group");S.append("rect").attr("class","timeline-base").attr("width",U).attr("height",z),D.append("rect").attr("class","timeline-base").attr("width",U).attr("height",z);var F=function(t){return P(new Date(2015,t-1,1,0,0,0,0))},M=new Date(2015,0,1,0,0,0,0),O=new Date(2016,0,1,0,0,0,0),P=d3.time.scale().domain([M,O]).range([0,U]),C=d3.svg.axis().scale(P).tickFormat(d3.time.format("%b")).orient("bottom");R.append("g").attr("class","x axis").attr("transform","translate(0,"+N+")").call(C),$(".output-timeline .x.axis .tick text").attr("x",U/24).attr("y",8).last().css("display","none"),e&&E.selectAll(".timeline-seasonal-base").data(App.inputs.malaria_peak_month_num).enter().append("rect").attr("class","timeline-seasonal-base").attr("x",function(t){return F(t)}).attr("width",function(t){return F(+t+1)-F(t)}).attr("height",z);var H=S.append("text").attr("class","y-label").attr("x",-15).attr("y",z/2+3).text("current");k?(H.attr("x",-33).attr("y",z/2-6),S.append("text").attr("class","y-label").attr("x",-10).attr("y",z/2+10).text("(recommended)")):D.append("text").attr("class","y-label").attr("x",-15).attr("y",z/2+3).text("recommended");var q=10,j=function(t,e,a,n){"string"==typeof e&&(e=+e);var i=F(e),r=F(e+1),s=t.append("g").attr("class","strat-group").attr("transform","translate("+i+","+n+")");s.append("rect").attr("class","strat-marker").attr("y",-q/2).attr("width",r-i).attr("height",q);var o=s.append("text").attr("x",-7).attr("y",4).text(a);return 0===i&&o.style("text-anchor","start").attr("x",r+7),i},W=App.inputs.itn+App.inputs.irs+1,V=2===W?[20,40]:[12,30,48],B=j(S,App.inputs.schisto_month_num,"PZQ",V[0]),Q=j(D,n.pzq_month,"PZQ",V[0]);if(App.inputs.irs)var Z=j(S,App.inputs.irs_month_num,"IRS",V[1]),L=j(D,n.spray_month,"IRS",V[1]);if(App.inputs.itn)var G=j(S,App.inputs.itn_month_num,"ITN",2===W?V[1]:V[2]),J=j(D,n.net_month,"ITN",2===W?V[1]:V[2]);E.append("line").attr("class","strat-divider").attr("x2",U).attr("y1",0).attr("y2",0),E.append("line").attr("class","strat-divider").attr("x2",U).attr("y1",z).attr("y2",z);var K=R.append("g").attr("class","timeline-legend").attr("transform","translate(0,"+(N+50)+")");if(e){var X=K.append("g").attr("transform","translate(222,0)");X.append("rect").attr("class","timeline-seasonal-base").attr("y",-1).attr("width",60).attr("height",16),X.append("text").attr("class","legend-text").attr("x",75).attr("y",12).text("Malaria Season")}var Y=K.append("g").attr("transform","translate(222,"+(e?30:0)+")");if(Y.append("rect").attr("class","strat-marker").attr("y",2).attr("width",60).attr("height",q),Y.append("text").attr("x",75).attr("y",12).text("Distribution of Treatment"),k)$(".output-timeline-rec-text").html("The <b>current</b> distribution times used for PZQ, IRS, and ITN are also the <b>recommended</b> distribution times."),E.style("display",function(t,e){return 1===e?"none":void 0});else{var tt="",et=[];if(B>Q&&et.push("<b>PZQ</b>"),Z>L&&et.push("<b>IRS</b>"),G>J&&et.push("<b>ITN</b>"),et.length>0){var at=1===et.length?"treatment":"treatments",nt=1===et.length?"is":"are";tt+="It is recommended that the "+at+", "+et.join(", ")+", "+nt+" applied at an earlier time."}if(et=[],Q>B&&et.push("<b>PZQ</b>"),L>Z&&et.push("<b>IRS</b>"),J>G&&et.push("<b>ITN</b>"),et.length>0){tt.length>0&&(tt+="<br>");var it=1===et.length?"treatment":"treatments",nt=1===et.length?"is":"are";tt+="It is recommended that the "+it+", "+et.join(", ")+", "+nt+" applied at a later time."}$(".output-timeline-rec-text").html(tt)}$(".assumption-bar").on("click",function(){var t=$(this),e=$(".assumption-contents"),a=e.is(":visible");e.slideToggle(),t.find(".down-arrow").toggleClass("rotated"),t.find("span").text(a?"show assumptions":"hide assumptions")}),$(".input-back-button").click(function(){hasher.setHash("")})}}();var App=App||{};!function(){var t=function(){App.initialize(),Routing.precompileTemplates(),Routing.initializeRoutes()};t()}();