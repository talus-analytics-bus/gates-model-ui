var App=App||{};!function(){App.inputs=null,App.outputs=null,App.initialize=function(){App.inputs=App.getCookie("inputs"),App.outputs=App.getCookie("outputs"),$(".header-title").click(function(){hasher.setHash("")}),$.noty.defaults.layout="center",$.noty.defaults.type="warning"},App.runModel=function(t,e){NProgress.start();var n=new Date;console.log("starting model run..."),$.get("/runModel",t).always(function(){console.log("finished model run: "+(new Date-n)/1e3+" seconds"),NProgress.done()}).fail(function(){e("error",null)}).done(function(t){t.hasOwnProperty("error")?e(t.error,null):e(null,t)})},App.setCookie=function(t,e,n){if("object"==typeof e&&(e=JSON.stringify(e)),e.length>=4094&&console.log("Cookie is too long! (over 4094 bytes)"),"undefined"==typeof n)var n=7;var a=new Date;a.setTime(a.getTime()+24*n*60*60*1e3);var i="expires="+a.toUTCString();document.cookie=t+"="+e+"; "+i},App.getCookie=function(t){for(var e=t+"=",n=document.cookie.split(";"),a=0;a<n.length;a++){var i=n[a].trim();if(0===i.indexOf(e)){var r=i.substring(e.length,i.length);return JSON.parse(r)}}return null}}();var Routing={};!function(){var t={};Routing.precompileTemplates=function(){$("script[type='text/x-handlebars-template']").each(function(e,n){t[n.id.replace("-template","")]=Handlebars.compile($(n).html())})},Routing.initializeRoutes=function(){crossroads.addRoute("/",function(){n("home"),App.initInput(),window.scrollTo(0,0)}),crossroads.addRoute("/output",function(){n("output"),App.initOutput(),window.scrollTo(0,0)}),hasher.prependHash="",hasher.initialized.add(e),hasher.changed.add(e),hasher.init()};var e=function(t){crossroads.parse(t)},n=function(e,n){$("#page-content").html(t[e](n))}}();var Util={};Util.comma=d3.format(",f"),Util.decimalize=d3.format(".2f"),Util.percentize=d3.format("%"),Util.percentizeDiff=function(t){return 0===t?"0%":d3.format("+%")(t)},Util.strToFloat=function(t){return"string"!=typeof t?t:parseFloat(t.replace(/[^\d\.\-]/g,""))},Util.formatInputVal=function(t){t=$(t);var e=Util.strToFloat(t.val()),n=Util.comma(e);return t.hasClass("percent-input")&&(e/=100,isNaN(e)||0>e?e=0:e>100&&(e=100),n=Util.percentize(e)),t.val(n),e},Util.getUnique=function(t){for(var e=[],n=0;n<t.length;n++)-1===e.indexOf(t[n])&&e.push(t[n]);return e},Util.copyObject=function(t){return $.extend(!0,{},t)};var App=App||{};!function(){App.initInput=function(){null!==App.inputs&&t(),$(".input-section .title").click(function(){var t=$(this).next().find(".input-subsection, .next-button-container"),e=t.is(":visible");e?t.slideUp():($(this).parent().siblings(".input-section").find(".input-subsection, .next-button-container").slideUp(),t.slideDown())}),$(".next-button-container .btn").click(function(){var t=!0;if("pop-age"===$(this).attr("name")&&(t=a()),t){var e=$(this).parent().parent(),n=e.find(".input-subsection, .next-button-container");n.slideUp(),e.parent().next(".input-section").find(".input-subsection, .next-button-container").slideDown()}});var e=[{age:"0-4",value:App.inputs?App.inputs.pop1:.2},{age:"5-15",value:App.inputs?App.inputs.pop2:.34},{age:"16+",value:App.inputs?App.inputs.pop3:.46}];d3.selectAll(".pop-age-table input").property("value",function(t,n){return Util.percentize(e[n].value)}).on("change",function(t,a){e[a].value=Util.formatInputVal(this),n(),h()});var n=function(){for(var t=0,n=0;n<e.length;n++)t+=e[n].value;return $(".pop-age-table tbody tr:last-child td:nth-child(2)").text(Util.percentize(t)),Math.abs(t-1)<.001?($(".pop-age-warning").slideUp(),$(".pop-age-table input").css("background-color","white"),!0):($(".pop-age-warning").slideDown(),$(".pop-age-table input").css("background-color","#ffdbdb"),!1)},a=function(){var t=n();return t||noty({text:"<b>Warning!</b><br>Age distributions must sum to 100%!"}),t},i={top:25,right:20,bottom:20,left:100},r=420-i.left-i.right,s=200-i.top-i.bottom,o=d3.select(".pop-age-chart").attr("width",r+i.left+i.right).attr("height",s+i.top+i.bottom).append("g").attr("transform","translate("+i.left+","+i.top+")"),p=d3.scale.ordinal().domain(e.map(function(t){return t.age})).rangeRoundBands([0,r],.2),l=d3.svg.axis().scale(p).orient("bottom"),c=(o.append("g").attr("class","x axis").attr("transform","translate(0,"+s+")").call(l),d3.scale.linear().domain([0,1]).range([s,0])),u=d3.svg.axis().orient("left").ticks(5).tickFormat(Util.percentize).innerTickSize(-r).outerTickSize(0).scale(c),h=(o.append("g").attr("class","y axis").call(u),function(){var t=o.selectAll("rect").data(e);t.enter().append("rect");t.attr("x",function(t){return p(t.age)}).attr("y",function(t){return c(t.value)}).attr("width",p.rangeBand()).attr("height",function(t){return s-c(t.value)}),t.exit().remove()});h(),$(".schisto-prevalence-container .explanation-icon").tooltipster({maxWidth:350,contentAsHTML:!0,content:"<b>Schistosomiasis prevalence</b> indicates the percentage of the population currently infected with schistosomiasis (medium-high intensity)."}),$(".schisto-prevalence").on("change",function(){var t=Math.round(Util.strToFloat($(this).val()));isNaN(t)?(noty({text:"<b>Error!</b><br>Please select a valid number for schistosomiasis prevalence."}),$(this).val(Util.percentize(.45))):0>=t?(noty({text:"<b>Warning!</b><br>The percentage for schistosomiasis prevalence must be <b>greater than 0%</b>."}),$(this).val(Util.percentize(.01))):t>100?(noty({text:"<b>Warning!</b><br>The maximum percentage for schistosomiasis prevalence is <b>100%</b>."}),$(this).val(Util.percentize(1))):$(this).val(Util.percentize(t/100))}),$(".schisto-age-select").multiselect(),$(".malaria-timing-select").on("change",function(){"seasonal"===$(this).val()?$(".malaria-month-container").slideDown():$(".malaria-month-container").slideUp()}),$(".irs-checkbox").on("change",function(){d()}),$(".irs-checkbox-label").on("click",function(){$(".irs-checkbox").prop("checked",!$(".irs-checkbox").is(":checked")),d()});var d=function(){$(".irs-true-contents").slideToggle(),g()};$(".itn-checkbox").on("change",function(){m()}),$(".itn-checkbox-label").on("click",function(){$(".itn-checkbox").prop("checked",!$(".itn-checkbox").is(":checked")),m()});var m=function(){$(".itn-true-contents").slideToggle(),g()},g=function(){var t=$(".irs-checkbox").is(":checked")&&$(".itn-checkbox").is(":checked");t?$('.input-subsection[name="distribution-strategy"]').slideDown():$('.input-subsection[name="distribution-strategy"]').slideUp()};$(".input-submit-button").click(function(){var t=[];d3.selectAll(".malaria-month-container input").each(function(e,n){$(this).is(":checked")&&t.push(n+1)}),console.log(t);var e={n_people:2e3,pop1:Util.strToFloat($(".pop-age-table tbody tr:first-child input").val())/100,pop2:Util.strToFloat($(".pop-age-table tbody tr:nth-child(2) input").val())/100,pop3:Util.strToFloat($(".pop-age-table tbody tr:nth-child(3) input").val())/100,schisto_prevalence:Util.strToFloat($(".schisto-prevalence").val())/100,schisto_coverage:Util.strToFloat($(".schisto-coverage-select").val()),schisto_age_range:$(".schisto-age-select").val(),schisto_month_num:$(".schisto-month-select").val(),malaria_timing:$(".malaria-timing-select").val(),malaria_peak_month_num:t,malaria_rate:Util.strToFloat($(".malaria-trans-rate-select").val()),irs:$(".irs-checkbox").is(":checked")?1:0,irs_coverage:Util.strToFloat($(".irs-coverage-select").val()),irs_month_num:$(".irs-month-select").val(),itn:$(".itn-checkbox").is(":checked")?1:0,itn_coverage:Util.strToFloat($(".itn-coverage-select").val()),itn_month_num:$(".itn-month-select").val()};if(a()===!1)return noty({text:"<b>Error!</b><br>Please make sure the age distribution in the population section adds up to 100%!"}),!1;if(null===e.schisto_age_range)return noty({text:"<b>Error!</b><br>Please select an age range for praziquantel mass drug administration under the schistosomiasis section."}),!1;if(!e.irs&&!e.itn)return noty({text:"<b>Error!</b><br>Please select either <b>IRS</b> or <b>ITN</b> as an option for treatment of malaria."}),!1;if("seasonal"===e.malaria_timing&&0===e.malaria_peak_month_num.length)return noty({text:"<b>Error!</b><br>Please select at least 1 peak transmission month for malaria."}),!1;if("seasonal"===e.malaria_timing&&e.malaria_peak_month_num.length>8)return noty({text:"<b>Error!</b><br>There may only be up to <b>8</b> peak transmission months for malaria.<br>There are currently <b>"+e.malaria_peak_month_num.length+"</b> months chosen."}),!1;App.inputs=e;var n=Util.copyObject(App.inputs);n.use_integration=1;var i=Util.copyObject(App.inputs);i.use_integration=0,queue().defer(App.runModel,n).defer(App.runModel,i).await(function(t,e,n){return t?(console.log("failed to complete all model runs"),console.log(t),noty({type:"alert",text:"<b>Error!</b><br>There was an error running the model. Please contact the developers."}),!1):(App.outputs={integrated:e,separate:n},App.setCookie("inputs",App.inputs),App.setCookie("outputs",App.outputs),void hasher.setHash("output"))})}),$('.input-section[name="pop-age"]').find(".input-subsection, .next-button-container").slideDown()};var t=function(){$(".schisto-coverage-select").val(String(App.inputs.schisto_coverage)),$(".schisto-age-select").val(App.inputs.schisto_age_range),$(".schisto-month-select").val(App.inputs.schisto_month_num),$(".malaria-timing-select").val(App.inputs.malaria_timing),"constant"===App.inputs.malaria_timing&&$(".malaria-month-container").hide(),d3.selectAll(".malaria-month-container input").property("checked",function(t,e){return App.inputs.malaria_peak_month_num.indexOf(e+1)>-1}),$(".malaria-trans-rate-select").val(App.inputs.malaria_rate),$(".irs-checkbox").prop("checked",App.inputs.irs),App.inputs.irs||$(".irs-true-contents").hide(),$(".irs-coverage-select").val(App.inputs.irs_coverage),$(".irs-month-select").val(App.inputs.irs_month_num),$(".itn-checkbox").prop("checked",App.inputs.itn),App.inputs.itn||$(".itn-true-contents").hide(),$(".itn-coverage-select").val(App.inputs.itn_coverage),$(".itn-month-select").val(App.inputs.itn_month_num)}}();var App=App||{};!function(){App.initOutput=function(){if(console.log(App.outputs),$.isEmptyObject(App.outputs))return hasher.setHash(""),!1;var t="seasonal"===App.inputs.malaria_timing,e=App.outputs.separate.malaria-App.outputs.integrated.malaria>=.05,n=e?App.outputs.integrated:App.outputs.separate;d3.select(".output-recommendation-text").text(e?"INTEGRATED INTERVENTIONS":"NON-INTEGRATED INTERVENTIONS").classed("text-success",e);var a="<b>Non-integrated interventions</b> is the default strategy and the status quo. It refers to the schedule the user is currently following for distributing medical countermeasures and vector control interventions.",i="<b>Integrated interventions</b> entails distributing medical countermeasures and vector control interventions for both diseases according to a schedule which the literature suggests is effective for reducing the prevalence of malaria and schistosomiasis.",r="This is the <b>recommended</b> strategy for the user.";e?i+=" "+r:a+=" "+r,$(".output-recommendation .explanation-icon").tooltipster({maxWidth:450,contentAsHTML:!0,content:a+"<br><br>"+i}),d3.selectAll(".output-table tbody tr").each(function(t,e){var n=0===e?App.outputs.separate:App.outputs.integrated,a=d3.select(this).selectAll("td:nth-child(3), td:nth-child(4)").text(function(t,e){var a=0===e?n.schisto:n.malaria;return Util.percentize(a)});1===e&&a.classed("text-success",function(t,e){var n=0===e?"schisto":"malaria";return Math.round(100*App.outputs.separate[n])-Math.round(100*App.outputs.integrated[n])>=2}).classed("text-danger",function(t,e){var n=0===e?"schisto":"malaria";return Math.round(100*App.outputs.integrated[n])-Math.round(100*App.outputs.separate[n])>=2})});var s=e?2:1;d3.select(".output-table tbody tr:nth-child("+s+") td:first-child").append("img").attr("class","arrow-icon").attr("src","img/chevron_right.png");var o=[{type:"without integration",disease:"schisto",value:App.outputs.separate.schisto},{type:"without integration",disease:"malaria",value:App.outputs.separate.malaria},{type:"with integration",disease:"schisto",value:App.outputs.integrated.schisto},{type:"with integration",disease:"malaria",value:App.outputs.integrated.malaria}],p={top:10,right:20,bottom:80,left:80},l=650-p.left-p.right,c=300-p.top-p.bottom,u=d3.select(".output-bar-chart").attr("width",l+p.left+p.right).attr("height",c+p.top+p.bottom).append("g").attr("transform","translate("+p.left+","+p.top+")"),h=d3.scale.ordinal().domain(Util.getUnique(o.map(function(t){return t.disease}))).rangeRoundBands([0,l],.5),d=d3.svg.axis().scale(h).orient("bottom"),m=(u.append("g").attr("class","x axis").attr("transform","translate(0,"+c+")").call(d),d3.scale.linear().domain([0,1]).range([c,0])),g=d3.svg.axis().orient("left").ticks(5).tickFormat(Util.percentize).innerTickSize(-l).outerTickSize(0).scale(m),b=(u.append("g").attr("class","y axis").call(g),u.selectAll("rect").data(o));b.enter().append("rect").attr("class","bar");b.style("fill",function(t){return"without integration"===t.type?"url(#diagonal-stripe-1)":"steelblue"}).attr("x",function(t){var e=h(t.disease)-20;return"with integration"===t.type&&(e+=40),e}).attr("y",function(t){return m(t.value)}).attr("width",h.rangeBand()).attr("height",function(t){return c-m(t.value)}),b.exit().remove();var f=u.append("g").attr("class","legend").attr("transform","translate(100,"+(c+50)+")"),v=f.selectAll("g").data(Util.getUnique(o.map(function(t){return t.type}))).enter().append("g").attr("transform",function(t,e){return"translate("+200*e+")"});v.append("rect").attr("width",15).attr("height",15).style("fill",function(t){return"without integration"===t?"url(#diagonal-stripe-1)":"steelblue"}),v.append("text").attr("transform","translate(25,13)").text(function(t){return t}),$(".output-table-container .explanation-icon:first-child").tooltipster({maxWidth:400,contentAsHTML:!0,content:"The values shown are prevalence values for schistosomiasis and malaria when <b>non-integrated interventions</b> are used"}),$(".output-table-container .explanation-icon:nth-child(2)").tooltipster({maxWidth:450,contentAsHTML:!0,content:"The values shown are prevalence values for schistosomiasis and malaria when <b>integrated interventions</b> are used. <br><br>Values are colored <b>green</b> if there is a non-trival reduction in prevalence (> 1% reduction). <br><br>Values are colored <b>red</b> if there is a non-trivial increase in prevalence (> 1% increase)."});var x=function(t){return d3.time.format("%B")(new Date(2015,t-1,1,0,0,0,0))};d3.select("#rec_pzq_month").text(x(n.pzq_month)),App.inputs.irs?d3.select("#rec_spray_month").text(x(n.spray_month)):$(".output-strategy-table tbody tr:nth-child(2)").hide(),App.inputs.itn?d3.select("#rec_net_month").text(x(n.net_month)):$(".output-strategy-table tbody tr:nth-child(3)").hide();var A=+App.inputs.schisto_month_num===+n.pzq_month&&+App.inputs.irs_month_num===+n.spray_month&&+App.inputs.itn_month_num===+n.net_month,y={top:20,right:105,bottom:t?105:70,left:105},_=800-p.left-p.right,k=60,w=20,T=A?k:2*k+w,U=d3.select(".output-timeline").attr("width",_+y.left+y.right).attr("height",T+y.top+y.bottom).append("g").attr("transform","translate("+y.left+","+y.top+")"),z=U.append("g").attr("class","timeline-group"),I=U.append("g").attr("class","timeline-group").attr("transform","translate(0,"+(k+w)+")"),N=U.selectAll(".timeline-group");z.append("rect").attr("class","timeline-base").attr("width",_).attr("height",k),I.append("rect").attr("class","timeline-base").attr("width",_).attr("height",k);var R=function(t){return E(new Date(2015,t-1,1,0,0,0,0))},S=new Date(2015,0,1,0,0,0,0),D=new Date(2016,0,1,0,0,0,0),E=d3.time.scale().domain([S,D]).range([0,_]),F=d3.svg.axis().scale(E).tickFormat(d3.time.format("%b")).orient("bottom");U.append("g").attr("class","x axis").attr("transform","translate(0,"+T+")").call(F),$(".output-timeline .x.axis .tick text").attr("x",_/24).attr("y",8).last().css("display","none"),t&&N.selectAll(".timeline-seasonal-base").data(App.inputs.malaria_peak_month_num).enter().append("rect").attr("class","timeline-seasonal-base").attr("x",function(t){return R(t)}).attr("width",function(t){return R(+t+1)-R(t)}).attr("height",k);var M=z.append("text").attr("class","y-label").attr("x",-15).attr("y",k/2+3).text("current");A?(M.attr("x",-33).attr("y",k/2-6),z.append("text").attr("class","y-label").attr("x",-10).attr("y",k/2+10).text("(recommended)")):I.append("text").attr("class","y-label").attr("x",-15).attr("y",k/2+3).text("recommended");var O=10,P=function(t,e,n,a){"string"==typeof e&&(e=+e);var i=R(e),r=R(e+1),s=t.append("g").attr("class","strat-group").attr("transform","translate("+i+","+a+")");s.append("rect").attr("class","strat-marker").attr("y",-O/2).attr("width",r-i).attr("height",O);var o=s.append("text").attr("x",-7).attr("y",4).text(n);return 0===i&&o.style("text-anchor","start").attr("x",r+7),i},q=App.inputs.itn+App.inputs.irs+1,C=2===q?[20,40]:[12,30,48],H=P(z,App.inputs.schisto_month_num,"PZQ",C[0]),j=P(I,n.pzq_month,"PZQ",C[0]);if(App.inputs.irs)var W=P(z,App.inputs.irs_month_num,"IRS",C[1]),V=P(I,n.spray_month,"IRS",C[1]);if(App.inputs.itn)var B=P(z,App.inputs.itn_month_num,"ITN",2===q?C[1]:C[2]),Q=P(I,n.net_month,"ITN",2===q?C[1]:C[2]);N.append("line").attr("class","strat-divider").attr("x2",_).attr("y1",0).attr("y2",0),N.append("line").attr("class","strat-divider").attr("x2",_).attr("y1",k).attr("y2",k);var Z=U.append("g").attr("class","timeline-legend").attr("transform","translate(0,"+(T+50)+")");if(t){var L=Z.append("g").attr("transform","translate(222,0)");L.append("rect").attr("class","timeline-seasonal-base").attr("y",-1).attr("width",60).attr("height",16),L.append("text").attr("class","legend-text").attr("x",75).attr("y",12).text("Malaria Season")}var G=Z.append("g").attr("transform","translate(222,"+(t?30:0)+")");if(G.append("rect").attr("class","strat-marker").attr("y",2).attr("width",60).attr("height",O),G.append("text").attr("x",75).attr("y",12).text("Distribution of Treatment"),A)$(".output-timeline-rec-text").html("The <b>current</b> distribution times used for PZQ, IRS, and ITN are also the <b>recommended</b> distribution times."),N.style("display",function(t,e){return 1===e?"none":void 0});else{var J="",K=[];if(H>j&&K.push("<b>PZQ</b>"),W>V&&K.push("<b>IRS</b>"),B>Q&&K.push("<b>ITN</b>"),K.length>0){var X=1===K.length?"treatment":"treatments",Y=1===K.length?"is":"are";J+="It is recommended that the "+X+", "+K.join(", ")+", "+Y+" applied at an earlier time."}if(K=[],j>H&&K.push("<b>PZQ</b>"),V>W&&K.push("<b>IRS</b>"),Q>B&&K.push("<b>ITN</b>"),K.length>0){J.length>0&&(J+="<br>");var tt=1===K.length?"treatment":"treatments",Y=1===K.length?"is":"are";J+="It is recommended that the "+tt+", "+K.join(", ")+", "+Y+" applied at a later time."}$(".output-timeline-rec-text").html(J)}$(".assumption-bar").on("click",function(){var t=$(this),e=$(".assumption-contents"),n=e.is(":visible");e.slideToggle(),t.find(".down-arrow").toggleClass("rotated"),t.find("span").text(n?"show assumptions":"hide assumptions")}),$(".input-back-button").click(function(){hasher.setHash("")})}}();var App=App||{};!function(){var t=function(){App.initialize(),Routing.precompileTemplates(),Routing.initializeRoutes()};t()}();